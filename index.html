<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生成績查詢系統</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #333; }
        
        /* 表單樣式 */
        .login-box, .query-box { text-align: center; margin-bottom: 20px; }
        input, select { padding: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        button { padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        
        /* 表格樣式 */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .highlight { background-color: #e3f2fd; font-weight: bold; }
        
        /* 統計區塊 */
        .stats-section { margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .stat-card { display: inline-block; width: 48%; vertical-align: top; margin-bottom: 20px; }
        
        /* 載入中動畫 */
        #loading { display: none; text-align: center; color: #666; margin-top: 10px; }
        .error { color: red; text-align: center; margin-top: 10px; }
        
        @media (max-width: 600px) {
            .stat-card { width: 100%; }
            table { display: block; overflow-x: auto; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>學生成績查詢</h1>

    <div id="login-section" class="login-box">
        <p>請輸入身分證字號末五碼</p>
        <input type="text" id="id-last-5" placeholder="例如：12345" maxlength="5">
        <button onclick="login()">登入系統</button>
        <div id="login-msg" class="error"></div>
    </div>

    <div id="query-section" class="query-box" style="display:none;">
        <p>歡迎登入，請選擇評量：</p>
        <select id="sheet-selector">
            <option value="">載入中...</option>
        </select>
        <button onclick="fetchData()">查詢成績</button>
    </div>

    <div id="loading">資料讀取中，請稍候...</div>
    <div id="error-display" class="error"></div>

    <div id="result-area" style="display:none;">
        <h2>個人成績單</h2>
        <div id="student-info-table"></div>

        <div class="stats-section">
            <h2>班級統計數據 (定期評量)</h2>
            <p style="text-align:center; font-size:0.9em; color:#666;">高標定義：前 50% 學生之平均分數</p>
            <div id="stats-container"></div>
        </div>
    </div>
</div>

<script>
    // 【重要】請將下方網址換成您部署後的 Google Apps Script 網址
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzekSwvItsMThvKV6VI-jngpMS_-NllJuFXGZr6PLlOQzvmeMuvyDzoLp4Nc33Y51zhEQ/exec'; 

    let userLast5 = '';

    function login() {
        const input = document.getElementById('id-last-5').value.trim();
        if (input.length !== 5) {
            document.getElementById('login-msg').innerText = "請輸入正確的 5 碼數字";
            return;
        }
        userLast5 = input;
        
        // 切換介面
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('query-section').style.display = 'block';
        document.getElementById('loading').style.display = 'block';

        // 取得工作表清單
        fetch(`${GAS_URL}?action=getSheetNames`)
            .then(res => res.json())
            .then(names => {
                const select = document.getElementById('sheet-selector');
                select.innerHTML = '';
                names.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.innerText = name;
                    select.appendChild(opt);
                });
                document.getElementById('loading').style.display = 'none';
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading').innerText = "連線錯誤，請重新整理";
            });
    }

    function fetchData() {
        const sheetName = document.getElementById('sheet-selector').value;
        if (!sheetName) return;

        document.getElementById('result-area').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error-display').innerText = '';

        fetch(`${GAS_URL}?action=getData&sheetName=${encodeURIComponent(sheetName)}&idLast5=${userLast5}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                if (data.error) {
                    document.getElementById('error-display').innerText = data.error;
                    return;
                }

                renderStudentTable(data.student);
                renderStats(data.stats);
                document.getElementById('result-area').style.display = 'block';
            })
            .catch(err => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-display').innerText = "查詢失敗，請檢查網路或稍後再試。";
            });
    }

   function renderStudentTable(student) {
        let html = '<table><thead><tr>';
        const keys = Object.keys(student);
        
        // 建立標題列 (後端已經濾掉身分證了，這裡直接顯示即可)
        keys.forEach(key => {
            html += `<th>${key}</th>`;
        });
        html += '</tr></thead><tbody><tr>';
        
        // 建立資料列
        keys.forEach(key => {
            html += `<td>${student[key]}</td>`;
        });
        html += '</tr></tbody></table>';
        document.getElementById('student-info-table').innerHTML = html;
    }

    function renderStats(stats) {
        let html = '';
        
        for (const [subject, data] of Object.entries(stats)) {
            html += `<div class="stat-card">`;
            html += `<h3>${subject}</h3>`;
            html += `<table>
                        <tr><th>項目</th><th>分數</th></tr>
                        <tr><td>全班平均</td><td class="highlight">${data.avg}</td></tr>
                        <tr><td>高標 (前50%平均)</td><td class="highlight">${data.highStd}</td></tr>
                     </table>`;
            
            html += `<table>
                        <tr><th colspan="2">分數組距分佈 (共 ${data.count} 人)</th></tr>
                        <tr><td>100 分</td><td>${data.distribution['100']} 人</td></tr>
                        <tr><td>90 - 99 分</td><td>${data.distribution['90-99']} 人</td></tr>
                        <tr><td>80 - 89 分</td><td>${data.distribution['80-89']} 人</td></tr>
                        <tr><td>70 - 79 分</td><td>${data.distribution['70-79']} 人</td></tr>
                        <tr><td>60 - 69 分</td><td>${data.distribution['60-69']} 人</td></tr>
                        <tr><td>60 分以下</td><td>${data.distribution['below60']} 人</td></tr>
                     </table>`;
            html += `</div>`;
        }
        
        document.getElementById('stats-container').innerHTML = html;
    }
</script>

</body>
</html>
