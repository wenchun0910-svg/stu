<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; }
        .tab-button { transition: all 0.3s ease; border-bottom: 4px solid transparent; }
        .tab-button.active { border-bottom-color: #3b82f6; color: #1d4ed8; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 2rem; }
        .btn { transition: all 0.2s ease; border-radius: 8px; padding: 0.6rem 1.2rem; font-weight: 500; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-primary:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .input-field { border: 1px solid #d1d5db; border-radius: 8px; padding: 0.5rem 0.8rem; width: 100%; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 12px; max-width: 90%; width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <!-- Password Modal -->
    <div id="password-modal" class="modal-backdrop">
        <div class="modal-content text-center">
            <!-- Setup View -->
            <div id="password-setup-view">
                <h3 class="text-xl font-bold mb-2">é¦–æ¬¡ä½¿ç”¨è¨­å®š</h3>
                <p class="text-gray-600 mb-6">è«‹ç‚ºæœ¬ç³»çµ±è¨­å®šä¸€çµ„ç®¡ç†å¯†ç¢¼ã€‚</p>
                <div class="space-y-4">
                    <input type="password" id="new-password" class="input-field text-center" placeholder="è¼¸å…¥æ–°å¯†ç¢¼ (è‡³å°‘4ä½)">
                    <input type="password" id="confirm-password" class="input-field text-center" placeholder="å†æ¬¡ç¢ºèªå¯†ç¢¼">
                </div>
                <button id="set-password-btn" class="btn btn-primary w-full mt-6">è¨­å®šå¯†ç¢¼</button>
            </div>
            <!-- Login View -->
            <div id="password-login-view" class="hidden">
                <h3 class="text-xl font-bold mb-2">ç³»çµ±é–å®š</h3>
                <p class="text-gray-600 mb-6">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥ç¹¼çºŒã€‚</p>
                <input type="password" id="login-password" class="input-field text-center" placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼">
                <button id="login-btn" class="btn btn-primary w-full mt-6">ç™»å…¥</button>
            </div>
            <p id="password-error" class="text-red-500 text-sm mt-4 h-5"></p>
        </div>
    </div>


    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex justify-center items-center z-50 hidden">
        <div class="text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600 font-medium text-lg">ç³»çµ±è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-5xl hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">ğŸš€ å­¸ç”Ÿé»æ•¸ç®¡ç†ç³»çµ± (GASç‰ˆ)</h1>
            <p class="text-gray-500 mt-2">ä¸€å€‹å³æ™‚ã€äº’å‹•çš„ç­ç´šç®¡ç†å·¥å…·</p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6">
                <button onclick="switchTab('points')" class="tab-button active py-4 px-1 text-lg font-semibold text-gray-700" id="tab-points">æ¯é€±ç©é»</button>
                <button onclick="switchTab('roster')" class="tab-button py-4 px-1 text-lg font-semibold text-gray-600 hover:text-gray-800" id="tab-roster">å­¸ç”Ÿç®¡ç†</button>
                <button onclick="switchTab('redeem')" class="tab-button py-4 px-1 text-lg font-semibold text-gray-600 hover:text-gray-800" id="tab-redeem">é»æ•¸å…Œæ›</button>
            </nav>
        </div>

        <main>
            <!-- Points Tab -->
            <div id="content-points" class="card">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">æ¯é€±é»æ•¸ç´€éŒ„</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç›®å‰ç¸½é»æ•¸</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ¬é€±åŠ /æ¸›é»æ•¸</th>
                            </tr>
                        </thead>
                        <tbody id="points-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div class="mt-6 text-right">
                    <button id="batch-update-btn" class="btn btn-primary">å„²å­˜æ‰€æœ‰é»æ•¸è®Šæ›´</button>
                </div>
            </div>

            <!-- Roster Tab -->
            <div id="content-roster" class="card hidden">
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">æ‰¹æ¬¡åŒ¯å…¥åå–®</h2>
                        <p class="text-sm text-gray-500 mb-4">è«‹å°‡å­¸ç”Ÿå§“åè²¼å…¥ä¸‹æ–¹ï¼Œæ¯è¡Œä¸€å€‹å§“åã€‚<br>æ–°åŒ¯å…¥çš„å­¸ç”Ÿï¼Œé è¨­å¯†ç¢¼ç‚º <code class="bg-gray-200 px-1 rounded">0000</code>ã€‚</p>
                        <textarea id="batch-import-textarea" class="input-field w-full h-40" placeholder="å°æ˜&#10;å°è¯&#10;å°ç¾"></textarea>
                        <button id="batch-import-btn" class="btn btn-primary mt-4 w-full">æ‰¹æ¬¡åŒ¯å…¥</button>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">æ–°å¢å–®ä¸€å­¸ç”Ÿ</h2>
                        <p class="text-sm text-gray-500 mb-4">æ–°å­¸ç”Ÿçš„é è¨­å¯†ç¢¼ç‚º <code class="bg-gray-200 px-1 rounded">0000</code>ã€‚</p>
                        <input type="text" id="new-student-name" class="input-field w-full" placeholder="è¼¸å…¥å­¸ç”Ÿå§“å">
                        <button id="add-student-btn" class="btn btn-primary mt-4 w-full">æ–°å¢å­¸ç”Ÿ</button>
                    </div>
                </div>
                <hr class="my-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">ç›®å‰å­¸ç”Ÿåå–®èˆ‡å¯†ç¢¼ç®¡ç†</h2>
                    <ul id="roster-list" class="space-y-3"></ul>
                </div>
            </div>

            <!-- Redeem Tab -->
            <div id="content-redeem" class="card hidden">
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">å…Œæ›é»æ•¸</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">é¸æ“‡å­¸ç”Ÿ</label>
                                <select id="redeem-student-select" class="input-field mt-1"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å…Œæ›é»æ•¸</label>
                                <input type="number" id="redeem-points-input" class="input-field mt-1" placeholder="ä¾‹å¦‚: 50">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å‚™è¨» (å¯é¸å¡«)</label>
                                <input type="text" id="redeem-remarks-input" class="input-field mt-1" placeholder="ä¾‹å¦‚: å…Œæ›é‰›ç­†ä¸€æ”¯">
                            </div>
                            <button id="redeem-btn" class="btn btn-primary w-full !mt-6">ç¢ºèªå…Œæ›</button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">å…Œæ›æ­·å²ç´€éŒ„</h2>
                        <div class="mb-4">
                            <select id="log-search-select" class="input-field w-full">
                            </select>
                        </div>
                        <div class="overflow-auto h-64 border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">æ™‚é–“</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">å§“å</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">é»æ•¸</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">å‚™è¨»</th>
                                    </tr>
                                </thead>
                                <tbody id="redeem-log-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for messages -->
    <div id="message-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4">è¨Šæ¯</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <button id="modal-close-btn" class="btn btn-primary">é—œé–‰</button>
        </div>
    </div>

    <script>
        // --- UI Elements ---
        const passwordModal = document.getElementById('password-modal');
        const passwordError = document.getElementById('password-error');
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainApp = document.getElementById('app');
        const pointsTableBody = document.getElementById('points-table-body');
        const rosterList = document.getElementById('roster-list');
        const redeemStudentSelect = document.getElementById('redeem-student-select');
        const redeemLogBody = document.getElementById('redeem-log-body');
        let allButtons = []; // Will be populated after auth

        // --- State Management ---
        let studentsCache = [];
        let redeemLogCache = [];

        // --- UI Control ---
        const showLoading = () => loadingOverlay.classList.remove('hidden');
        const hideLoading = () => loadingOverlay.classList.add('hidden');
        const disableButtons = () => allButtons.forEach(b => b.disabled = true);
        const enableButtons = () => allButtons.forEach(b => b.disabled = false);

        // --- Tab Switching ---
        window.switchTab = (tabName) => {
            ['points', 'roster', 'redeem'].forEach(name => {
                document.getElementById(`content-${name}`).classList.add('hidden');
                document.getElementById(`tab-${name}`).classList.remove('active');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        };

        // --- Message Modal Logic ---
        const messageModal = document.getElementById('message-modal');
        const showMessage = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            messageModal.classList.remove('hidden');
        };
        document.getElementById('modal-close-btn').addEventListener('click', () => messageModal.classList.add('hidden'));
        
        // --- Password Logic ---
        const handlePasswordSetup = () => {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            passwordError.textContent = '';

            if (newPassword.length < 4) { passwordError.textContent = 'å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦4å€‹å­—å…ƒã€‚'; return; }
            if (newPassword !== confirmPassword) { passwordError.textContent = 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ç›¸ç¬¦ã€‚'; return; }
            
            document.getElementById('set-password-btn').disabled = true;
            google.script.run
                .withSuccessHandler(() => {
                    passwordModal.classList.add('hidden');
                    initializeApp();
                })
                .withFailureHandler(err => {
                    passwordError.textContent = err.message;
                    document.getElementById('set-password-btn').disabled = false;
                })
                .setSystemPassword(newPassword);
        };

        const handlePasswordLogin = () => {
            const password = document.getElementById('login-password').value;
            passwordError.textContent = '';
            if (!password) { passwordError.textContent = 'è«‹è¼¸å…¥å¯†ç¢¼ã€‚'; return; }

            document.getElementById('login-btn').disabled = true;
            google.script.run
                .withSuccessHandler(isValid => {
                    if (isValid) {
                        passwordModal.classList.add('hidden');
                        initializeApp();
                    } else {
                        passwordError.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚';
                        document.getElementById('login-btn').disabled = false;
                    }
                })
                .withFailureHandler(err => {
                    passwordError.textContent = 'ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + err.message;
                    document.getElementById('login-btn').disabled = false;
                })
                .verifySystemPassword(password);
        };

        // --- Render Functions ---
        const renderAll = () => {
            studentsCache.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            redeemLogCache.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            renderStudents();
            renderRedeemLog();
            document.getElementById('log-search-select').value = '';
        }

        const renderStudents = () => {
            pointsTableBody.innerHTML = ''; rosterList.innerHTML = '';
            redeemStudentSelect.innerHTML = '<option value="">è«‹é¸æ“‡å­¸ç”Ÿ</option>';
            const logSearchSelect = document.getElementById('log-search-select');
            logSearchSelect.innerHTML = '<option value="">ç¯©é¸å…¨éƒ¨å­¸ç”Ÿç´€éŒ„</option>';

            if (studentsCache.length === 0) {
                pointsTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-10 text-gray-500">å°šç„¡å­¸ç”Ÿè³‡æ–™ï¼Œè«‹è‡³ã€Œå­¸ç”Ÿç®¡ç†ã€åˆ†é æ–°å¢ã€‚</td></tr>`;
                rosterList.innerHTML = `<li class="text-center py-4 text-gray-500">å°šç„¡å­¸ç”Ÿè³‡æ–™</li>`; return;
            }
            studentsCache.forEach(student => {
                pointsTableBody.innerHTML += `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-bold text-lg">${student.totalPoints}</td><td class="px-6 py-4 whitespace-nowrap"><input type="number" class="input-field w-24" data-id="${student.id}" placeholder="+/-"></td></tr>`;
                rosterList.innerHTML += `<li class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center bg-gray-50 p-3 rounded-lg"><span class="text-gray-800 font-medium">${student.name}</span><div class="flex items-center gap-2"><input type="text" id="pw-${student.id}" class="input-field text-sm w-full" value="${student.password}"><button class="btn btn-secondary text-xs" onclick="handleUpdatePassword('${student.id}', '${student.name}')">æ”¹å¯†ç¢¼</button></div><div class="text-right"><button class="btn btn-danger text-xs" onclick="handleDeleteStudent('${student.id}', '${student.name}')">åˆªé™¤å­¸ç”Ÿ</button></div></li>`;
                redeemStudentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.totalPoints}é»)</option>`;
                logSearchSelect.innerHTML += `<option value="${student.name}">${student.name}</option>`;
            });
        };

        const renderRedeemLog = (logsToRender = redeemLogCache) => {
            redeemLogBody.innerHTML = '';
            if (logsToRender.length === 0) {
                redeemLogBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">å°šç„¡ç¬¦åˆçš„å…Œæ›ç´€éŒ„</td></tr>`; return;
            }
            logsToRender.forEach(log => {
                redeemLogBody.innerHTML += `<tr><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${new Date(log.timestamp).toLocaleDateString()}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${log.studentName}</td><td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-red-500">${log.pointsRedeemed}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${log.remarks || ''}</td></tr>`;
            });
        };
        
        function handleFailure(error) { showMessage('éŒ¯èª¤', error.message); enableButtons(); }
        
        function handleBatchUpdatePoints() {
            const inputs = document.querySelectorAll('#points-table-body input[type="number"]');
            const updates = [];
            inputs.forEach(input => {
                const value = parseInt(input.value, 10);
                if (!isNaN(value) && value !== 0) { updates.push({ id: input.dataset.id, points: value }); }
            });
            if (updates.length === 0) { showMessage('æç¤º', 'æ²’æœ‰åµæ¸¬åˆ°ä»»ä½•é»æ•¸è®Šæ›´ã€‚'); return; }
            disableButtons();
            google.script.run.withSuccessHandler(updatedStudents => {
                updatedStudents.forEach(updated => {
                    const index = studentsCache.findIndex(s => s.id === updated.id);
                    if (index !== -1) studentsCache[index] = updated;
                });
                renderAll(); showMessage('æˆåŠŸ', `å·²æˆåŠŸæ›´æ–° ${updatedStudents.length} ä½å­¸ç”Ÿçš„é»æ•¸ã€‚`); enableButtons();
            }).withFailureHandler(handleFailure).batchUpdatePoints(updates);
        }

        // --- App Initialization & Event Binding ---
        function initializeApp() {
            mainApp.classList.add('hidden');
            showLoading();
            google.script.run
                .withSuccessHandler(data => {
                    studentsCache = data.students; redeemLogCache = data.logs;
                    allButtons = document.querySelectorAll('#app button'); // Populate buttons after main app is visible in DOM
                    
                    document.getElementById('batch-update-btn').addEventListener('click', handleBatchUpdatePoints);
                    
                    <!-- ADD THIS NEW LINE -->
                    document.getElementById('batch-import-points-btn').addEventListener('click', handleBatchImportPoints);
                    
                    document.getElementById('add-student-btn').addEventListener('click', () => {
                        const nameInput = document.getElementById('new-student-name');
                        const name = nameInput.value.trim();
                        if (!name) { showMessage('æç¤º', 'è«‹è¼¸å…¥å­¸ç”Ÿå§“åã€‚'); return; }
                        disableButtons();
                        google.script.run.withSuccessHandler(newStudent => {
                            studentsCache.push(newStudent); renderAll(); nameInput.value = '';
                            showMessage('æˆåŠŸ', `å·²æ–°å¢å­¸ç”Ÿï¼š${name} (é è¨­å¯†ç¢¼ 0000)`); enableButtons();
                        }).withFailureHandler(handleFailure).addStudent(name);
                    });
                    document.getElementById('batch-import-btn').addEventListener('click', () => {
                        const textarea = document.getElementById('batch-import-textarea');
                        const names = textarea.value.split('\n').map(n => n.trim()).filter(Boolean);
                        if (names.length === 0) { showMessage('æç¤º', 'è«‹åœ¨æ–‡å­—æ¡†ä¸­è¼¸å…¥å­¸ç”Ÿå§“åã€‚'); return; }
                        disableButtons();
                        google.script.run.withSuccessHandler(newStudents => {
                            studentsCache.push(...newStudents); renderAll(); textarea.value = '';
                            showMessage('æˆåŠŸ', `æˆåŠŸåŒ¯å…¥ ${names.length} ä½å­¸ç”Ÿï¼(é è¨­å¯†ç¢¼ 0000)`); enableButtons();
                        }).withFailureHandler(handleFailure).batchImportStudents(names);
                    });
                    document.getElementById('redeem-btn').addEventListener('click', () => {
                        const studentId = redeemStudentSelect.value;
                        const pointsInput = document.getElementById('redeem-points-input');
                        const remarksInput = document.getElementById('redeem-remarks-input');
                        const pointsToRedeem = parseInt(pointsInput.value, 10);
                        const remarks = remarksInput.value.trim();
                        if (!studentId) { showMessage('æç¤º', 'è«‹é¸æ“‡ä¸€ä½å­¸ç”Ÿã€‚'); return; }
                        if (isNaN(pointsToRedeem) || pointsToRedeem <= 0) { showMessage('æç¤º', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„å…Œæ›é»æ•¸ã€‚'); return; }
                        disableButtons();
                        google.script.run.withSuccessHandler(result => {
                            const { updatedStudent, newLog } = result;
                            const index = studentsCache.findIndex(s => s.id === updatedStudent.id);
                            if (index !== -1) studentsCache[index] = updatedStudent;
                            redeemLogCache.push(newLog); renderAll();
                            pointsInput.value = ''; remarksInput.value = ''; redeemStudentSelect.value = '';
                            showMessage('æˆåŠŸ', `å·²ç‚º ${updatedStudent.name} å…Œæ› ${newLog.pointsRedeemed} é»ã€‚`); enableButtons();
                        }).withFailureHandler(handleFailure).redeemPoints(studentId, pointsToRedeem, remarks);
                    });
                    
                    const logSearchSelect = document.getElementById('log-search-select');
                    logSearchSelect.addEventListener('change', () => {
                        const selectedName = logSearchSelect.value;
                        if (selectedName) {
                            const filteredLogs = redeemLogCache.filter(log => log.studentName === selectedName);
                            renderRedeemLog(filteredLogs);
                        } else {
                            renderRedeemLog(redeemLogCache);
                        }
                    });
                    
                    renderAll();
                    hideLoading(); mainApp.classList.remove('hidden');
                })
                .withFailureHandler(error => {
                    document.getElementById('loading-overlay').innerHTML = `<p class="text-red-500 font-bold p-4 text-center">ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}ã€‚<br>è«‹å˜—è©¦åœ¨ Google Sheet ä¸­æ‰‹å‹•åŸ·è¡Œ 'setupSheets' åŠŸèƒ½ã€‚</p>`;
                })
                .getInitialData();
        }

        <!-- ADD THIS NEW FUNCTION -->
        function handleBatchImportPoints() {
            const textarea = document.getElementById('batch-points-textarea');
            const text = textarea.value.trim();
            if (!text) {
                showMessage('æç¤º', 'è«‹åœ¨æ–‡å­—æ¡†ä¸­è²¼ä¸Šè³‡æ–™ã€‚');
                return;
            }

            const updates = [];
            const lines = text.split('\n');
            const errors = [];

            lines.forEach((line, index) => {
                const parts = line.split(',');
                if (parts.length === 2) {
                    const name = parts[0].trim();
                    const points = parseInt(parts[1].trim(), 10);
                    if (name && !isNaN(points)) {
                        updates.push({ name, points });
                    } else {
                        errors.push(`ç¬¬ ${index + 1} è¡Œæ ¼å¼éŒ¯èª¤: ${line}`);
                    }
                } else if (line.trim()) { // Ignore empty lines but report malformed lines
                    errors.push(`ç¬¬ ${index + 1} è¡Œæ ¼å¼éŒ¯èª¤ (ç¼ºå°‘é€—è™Ÿ): ${line}`);
                }
            });

            if (updates.length === 0) {
                let errorMsg = 'æ²’æœ‰è§£æåˆ°ä»»ä½•æœ‰æ•ˆçš„è³‡æ–™ã€‚';
                if(errors.length > 0) errorMsg += '\n\néŒ¯èª¤è©³æƒ…:\n' + errors.join('\n');
                showMessage('éŒ¯èª¤', errorMsg);
                return;
            }

            disableButtons();
            google.script.run
                .withSuccessHandler(result => {
                    // Update cache
                    result.updatedStudents.forEach(updated => {
                        const index = studentsCache.findIndex(s => s.id === updated.id);
                        if (index !== -1) studentsCache[index] = updated;
                    });
                    renderAll(); // Re-render everything with new totals
                    textarea.value = ''; // Clear textarea

                    // Build summary message
                    let summary = `æˆåŠŸæ›´æ–° ${result.updatedStudents.length} ä½å­¸ç”Ÿçš„é»æ•¸ã€‚`;
                    if (result.notFound.length > 0) {
                        summary += `\n\næ‰¾ä¸åˆ° ${result.notFound.length} ä½å­¸ç”Ÿï¼š\n` + result.notFound.join(', ');
                    }
                    if (errors.length > 0) {
                        summary += `\n\n${errors.length} è¡Œè³‡æ–™æ ¼å¼éŒ¯èª¤å·²è¢«å¿½ç•¥ã€‚`;
                    }
                    showMessage('æ‰¹æ¬¡åŒ¯å…¥å®Œæˆ', summary);
                    enableButtons();
                })
                .withFailureHandler(handleFailure)
                .bulkAddPointsByName(updates);
        }

        window.handleDeleteStudent = (studentId, studentName) => {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å­¸ç”Ÿ "${studentName}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) return;
            disableButtons();
            google.script.run.withSuccessHandler(deletedId => {
                studentsCache = studentsCache.filter(s => s.id !== deletedId); renderAll();
                showMessage('æˆåŠŸ', `å·²åˆªé™¤å­¸ç”Ÿ ${studentName}ã€‚`); enableButtons();
            }).withFailureHandler(handleFailure).deleteStudent(studentId);
        };
        
        window.handleUpdatePassword = (studentId, studentName) => {
            const passwordInput = document.getElementById(`pw-${studentId}`);
            const newPassword = passwordInput.value.trim();
            if (newPassword.length < 4) { showMessage('æç¤º', 'å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦4å€‹å­—å…ƒã€‚'); return; }
            disableButtons();
            google.script.run.withSuccessHandler(result => {
                const index = studentsCache.findIndex(s => s.id === result.studentId);
                if(index !== -1) studentsCache[index].password = result.newPassword;
                showMessage('æˆåŠŸ', `å·²æ›´æ–° ${studentName} çš„å¯†ç¢¼ã€‚`); enableButtons();
            }).withFailureHandler(handleFailure).updateStudentPassword(studentId, newPassword);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('set-password-btn').addEventListener('click', handlePasswordSetup);
            document.getElementById('login-btn').addEventListener('click', handlePasswordLogin);
            document.getElementById('login-password').addEventListener('keyup', (e) => e.key === 'Enter' && handlePasswordLogin());
            document.getElementById('confirm-password').addEventListener('keyup', (e) => e.key === 'Enter' && handlePasswordSetup());

            google.script.run
                .withSuccessHandler(isSet => {
                    if (isSet) {
                        document.getElementById('password-setup-view').classList.add('hidden');
                        document.getElementById('password-login-view').classList.remove('hidden');
                    } else {
                        document.getElementById('password-setup-view').classList.remove('hidden');
                        document.getElementById('password-login-view').classList.add('hidden');
                    }
                }).withFailureHandler(err => {
                    passwordError.textContent = 'ç„¡æ³•æª¢æŸ¥å¯†ç¢¼ç‹€æ…‹: ' + err.message;
                }).isPasswordSet();
        });
    </script>
</body>
</html>


