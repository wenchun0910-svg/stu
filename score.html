<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生成績查詢系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 設定你的 Google Apps Script URL ---
        // 如果要發布給學生，建議將下方空字串替換成你的 "Web App URL"
        // 例如: const DEFAULT_API_URL = "https://script.google.com/macros/s/XXXXX/exec";
        const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbybeCY7iV5XKqr4D_-lTzfrixlfiEB-6qBUJHPS77S2XK9mFXiFpVA7kSOPZCUQxGN5Dg/exec"; 

        const App = () => {
            const [view, setView] = useState('login'); // login, dashboard
            const [idCode, setIdCode] = useState('');
            const [apiUrl, setApiUrl] = useState(DEFAULT_API_URL);
            const [sheets, setSheets] = useState([]);
            const [selectedSheet, setSelectedSheet] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [studentData, setStudentData] = useState(null);
            const [statsData, setStatsData] = useState(null);
            
            // 模擬模式 (當沒有 API URL 時展示範例資料)
            const [isDemo, setIsDemo] = useState(false);

            // 初始化：如果有 API URL，嘗試抓取工作表列表
            useEffect(() => {
                if (apiUrl && !isDemo) {
                    fetchSheets();
                } else if (!apiUrl) {
                    // 如果沒有預設 API URL，提示使用者或進入 Demo 模式
                    // 這裡為了預覽效果，預設未填時不動作，等待使用者輸入
                }
            }, [apiUrl]);

            const fetchSheets = async () => {
                setLoading(true);
                setError('');
                try {
                    const response = await fetch(`${apiUrl}?action=getSheets`);
                    const data = await response.json();
                    setSheets(data);
                    if (data.length > 0) setSelectedSheet(data[0]);
                } catch (err) {
                    console.error("Fetch Error", err);
                    setError("無法連結資料庫，請檢查 URL 是否正確。");
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!idCode || idCode.length !== 5) {
                    setError("請輸入正確的身分證後五碼");
                    return;
                }
                
                if (!apiUrl && !isDemo) {
                    // Demo mode handling for preview
                    setIsDemo(true);
                    mockLogin();
                    return;
                }

                if (isDemo) {
                    mockLogin();
                    return;
                }

                // 真實登入
                fetchData(selectedSheet);
            };

            const mockLogin = () => {
                setLoading(true);
                setTimeout(() => {
                    setSheets(['第一學期第一次評量', '第一學期第二次評量']);
                    setSelectedSheet('第一學期第一次評量');
                    mockFetchData();
                    setLoading(false);
                }, 1000);
            };

            const mockFetchData = () => {
                setView('dashboard');
                // 產生假資料
                setStudentData({
                    seat: "05",
                    name: "王小明",
                    avg: 88.5,
                    total: 442.5,
                    scores: {
                        "國語": { "定期": 88, "平時": 90 },
                        "英語": { "定期": 92, "平時": 95 },
                        "數學": { "定期": 78, "平時": 85 },
                        "社會": { "定期": 95, "平時": 92 },
                        "自然": { "定期": 85, "平時": 88 }
                    }
                });
                setStatsData({
                    "國語": { avg: 82.3, highScore: 90, dist: { "100": 1, "90-99": 5, "80-89": 10, "70-79": 8, "60-69": 4, "under60": 2 } },
                    "英語": { avg: 75.5, highScore: 88, dist: { "100": 0, "90-99": 3, "80-89": 8, "70-79": 10, "60-69": 6, "under60": 3 } },
                    "數學": { avg: 68.2, highScore: 85, dist: { "100": 0, "90-99": 2, "80-89": 5, "70-79": 8, "60-69": 8, "under60": 7 } },
                    "社會": { avg: 85.1, highScore: 94, dist: { "100": 2, "90-99": 8, "80-89": 12, "70-79": 6, "60-69": 2, "under60": 0 } },
                    "自然": { avg: 79.4, highScore: 89, dist: { "100": 1, "90-99": 4, "80-89": 9, "70-79": 9, "60-69": 5, "under60": 2 } },
                });
            };

            const fetchData = async (sheetName) => {
                setLoading(true);
                setError('');
                try {
                    const url = `${apiUrl}?action=getData&sheetName=${encodeURIComponent(sheetName)}&loginId=${idCode}`;
                    const response = await fetch(url);
                    const json = await response.json();
                    
                    if (json.status === 'error') {
                        setError(json.message);
                    } else {
                        setStudentData(json.data);
                        setStatsData(json.stats);
                        setView('dashboard');
                    }
                } catch (err) {
                    setError("讀取資料失敗，請稍後再試。");
                } finally {
                    setLoading(false);
                }
            };

            const handleSheetChange = (e) => {
                const newSheet = e.target.value;
                setSelectedSheet(newSheet);
                if (isDemo) {
                    // Just refresh mock data
                } else {
                    fetchData(newSheet);
                }
            };

            const handleLogout = () => {
                setView('login');
                setIdCode('');
                setStudentData(null);
                setStatsData(null);
                setError('');
            };

            return (
                <div className="min-h-screen flex items-center justify-center py-8 px-4">
                    {view === 'login' ? (
                        <div className="glass-card w-full max-w-md p-8 rounded-2xl shadow-xl animate-fade-in">
                            <div className="text-center mb-8">
                                <i className="ph ph-student text-5xl text-blue-600 mb-3"></i>
                                <h1 className="text-2xl font-bold text-gray-800">成績查詢系統</h1>
                                <p className="text-gray-500 text-sm mt-2">請輸入資料進行驗證</p>
                            </div>

                            <form onSubmit={handleLogin} className="space-y-6">
                                {/* API URL Setting (Optional/Hidden in production) */}
                                {(!DEFAULT_API_URL && !isDemo) && (
                                    <div className="bg-yellow-50 p-3 rounded border border-yellow-200 text-xs text-yellow-800 mb-4">
                                        <label className="block font-bold mb-1">系統設定 (首次使用請填寫):</label>
                                        <input 
                                            type="text" 
                                            placeholder="請貼上 Google Apps Script 網址"
                                            className="w-full p-2 border rounded"
                                            value={apiUrl}
                                            onChange={(e) => setApiUrl(e.target.value)}
                                        />
                                        <div className="mt-1 text-gray-400">若未填寫將進入演示模式 (Demo Mode)</div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">身分證字號 (後五碼)</label>
                                    <input 
                                        type="text" 
                                        value={idCode}
                                        onChange={(e) => setIdCode(e.target.value)}
                                        placeholder="例如: 12345"
                                        maxLength="5"
                                        className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                    />
                                </div>

                                {error && (
                                    <div className="flex items-center text-red-600 text-sm bg-red-50 p-3 rounded-lg">
                                        <i className="ph ph-warning-circle mr-2"></i>
                                        {error}
                                    </div>
                                )}

                                <button 
                                    type="submit" 
                                    disabled={loading}
                                    className="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 px-4 rounded-lg transition transform active:scale-95 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center"
                                >
                                    {loading ? (
                                        <i className="ph ph-spinner animate-spin text-xl"></i>
                                    ) : "登入查詢"}
                                </button>
                            </form>
                        </div>
                    ) : (
                        <div className="w-full max-w-5xl animate-fade-in space-y-6">
                            {/* Header Bar */}
                            <div className="glass-card rounded-xl p-4 flex flex-col md:flex-row justify-between items-center shadow-sm">
                                <div className="flex items-center space-x-4 mb-4 md:mb-0 w-full md:w-auto">
                                    <div className="bg-blue-100 p-2 rounded-full">
                                        <i className="ph ph-exam text-blue-600 text-xl"></i>
                                    </div>
                                    <select 
                                        value={selectedSheet} 
                                        onChange={handleSheetChange}
                                        className="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full md:w-64 p-2.5"
                                    >
                                        {sheets.map(sheet => (
                                            <option key={sheet} value={sheet}>{sheet}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div className="flex items-center space-x-4">
                                    <div className="text-right hidden md:block">
                                        <div className="text-sm font-bold text-gray-800">{studentData?.name}</div>
                                        <div className="text-xs text-gray-500">座號: {studentData?.seat}</div>
                                    </div>
                                    <button 
                                        onClick={handleLogout}
                                        className="text-gray-500 hover:text-red-600 transition p-2"
                                        title="登出"
                                    >
                                        <i className="ph ph-sign-out text-xl"></i>
                                    </button>
                                </div>
                            </div>

                            {/* Main Score Card */}
                            {loading ? (
                                <div className="text-center py-20">
                                    <i className="ph ph-spinner animate-spin text-4xl text-blue-500"></i>
                                    <p className="mt-4 text-gray-500">資料讀取中...</p>
                                </div>
                            ) : (
                                <>
                                    {/* Student Score Table */}
                                    <div className="glass-card rounded-2xl shadow-lg overflow-hidden">
                                        <div className="bg-blue-600 px-6 py-4">
                                            <h2 className="text-white font-bold flex items-center">
                                                <i className="ph ph-table mr-2"></i> 個人成績一覽
                                            </h2>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left text-gray-600">
                                                <thead className="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                                    <tr>
                                                        <th className="px-4 py-3 text-center">科目</th>
                                                        {['國語', '英語', '數學', '社會', '自然'].map(s => (
                                                            <th key={s} className="px-4 py-3 text-center bg-blue-50/50">{s}</th>
                                                        ))}
                                                        <th className="px-4 py-3 text-center bg-yellow-50">統計</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr className="border-b hover:bg-gray-50">
                                                        <td className="px-4 py-4 font-bold text-gray-900 text-center bg-gray-50">定期</td>
                                                        {['國語', '英語', '數學', '社會', '自然'].map(s => (
                                                            <td key={s} className="px-4 py-4 text-center font-medium text-blue-600">
                                                                {studentData?.scores[s]?.["定期"] || "-"}
                                                            </td>
                                                        ))}
                                                        <td className="px-4 py-4 text-center font-bold text-gray-800 bg-yellow-50/30" rowSpan="2">
                                                            <div className="space-y-1">
                                                                <div className="flex justify-between text-xs"><span>總分:</span> <span>{studentData?.total}</span></div>
                                                                <div className="flex justify-between text-xs"><span>平均:</span> <span className="text-blue-600">{studentData?.avg}</span></div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr className="border-b hover:bg-gray-50">
                                                        <td className="px-4 py-4 font-bold text-gray-900 text-center bg-gray-50">平時</td>
                                                        {['國語', '英語', '數學', '社會', '自然'].map(s => (
                                                            <td key={s} className="px-4 py-4 text-center text-gray-500">
                                                                {studentData?.scores[s]?.["平時"] || "-"}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                    {/* Class Stats Row */}
                                                    <tr className="bg-gray-50 border-t-2 border-gray-200">
                                                        <td className="px-4 py-3 font-bold text-gray-500 text-center text-xs">班平均</td>
                                                        {['國語', '英語', '數學', '社會', '自然'].map(s => (
                                                            <td key={s} className="px-4 py-3 text-center text-xs text-gray-500">
                                                                {statsData?.[s]?.avg || "-"}
                                                            </td>
                                                        ))}
                                                        <td className="bg-white"></td>
                                                    </tr>
                                                    <tr className="bg-gray-50">
                                                        <td className="px-4 py-3 font-bold text-purple-600 text-center text-xs">高標</td>
                                                        {['國語', '英語', '數學', '社會', '自然'].map(s => (
                                                            <td key={s} className="px-4 py-3 text-center text-xs text-purple-600 font-bold">
                                                                {statsData?.[s]?.highScore || "-"}
                                                            </td>
                                                        ))}
                                                        <td className="bg-white"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* Distribution Cards */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {['國語', '英語', '數學', '社會', '自然'].map(subject => {
                                            const dist = statsData?.[subject]?.dist;
                                            if (!dist) return null;
                                            
                                            return (
                                                <div key={subject} className="glass-card rounded-xl p-5 shadow-sm border-t-4 border-blue-500">
                                                    <h3 className="font-bold text-gray-800 mb-4 flex justify-between">
                                                        <span>{subject} 組距分析</span>
                                                        <span className="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">定期</span>
                                                    </h3>
                                                    <div className="space-y-3">
                                                        {[
                                                            { label: '100分', key: '100', color: 'bg-green-500' },
                                                            { label: '90-99分', key: '90-99', color: 'bg-emerald-400' },
                                                            { label: '80-89分', key: '80-89', color: 'bg-blue-400' },
                                                            { label: '70-79分', key: '70-79', color: 'bg-indigo-400' },
                                                            { label: '60-69分', key: '60-69', color: 'bg-yellow-400' },
                                                            { label: '60分以下', key: 'under60', color: 'bg-red-400' },
                                                        ].map((range) => {
                                                            const count = dist[range.key];
                                                            const total = statsData[subject].count || 1;
                                                            const percentage = (count / total) * 100;
                                                            
                                                            return (
                                                                <div key={range.key} className="flex items-center text-xs">
                                                                    <div className="w-16 font-medium text-gray-600">{range.label}</div>
                                                                    <div className="flex-1 mx-2 bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                                                        <div 
                                                                            className={`h-2.5 rounded-full ${range.color}`} 
                                                                            style={{ width: `${percentage}%` }}
                                                                        ></div>
                                                                    </div>
                                                                    <div className="w-8 text-right font-bold text-gray-700">{count}人</div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
