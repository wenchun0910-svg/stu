<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生成績查詢系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* Custom Scrollbar for table */
        .scrollbar-hide::-webkit-scrollbar {
            height: 8px;
        }
        .scrollbar-hide::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .scrollbar-hide::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .scrollbar-hide::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 設定你的 Google Apps Script URL ---
        // 例如: const DEFAULT_API_URL = "https://script.google.com/macros/s/XXXXX/exec";
        const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbybeCY7iV5XKqr4D_-lTzfrixlfiEB-6qBUJHPS77S2XK9mFXiFpVA7kSOPZCUQxGN5Dg/exec"; 

        const App = () => {
            const [view, setView] = useState('login'); // login, dashboard
            const [idCode, setIdCode] = useState('');
            const [apiUrl, setApiUrl] = useState(DEFAULT_API_URL);
            const [sheets, setSheets] = useState([]);
            const [selectedSheet, setSelectedSheet] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [studentData, setStudentData] = useState(null);
            const [statsData, setStatsData] = useState(null);
            
            // 模擬模式
            const [isDemo, setIsDemo] = useState(false);

            useEffect(() => {
                if (apiUrl && !isDemo) {
                    fetchSheets();
                }
            }, [apiUrl]);

            const fetchSheets = async () => {
                setLoading(true);
                setError('');
                try {
                    const response = await fetch(`${apiUrl}?action=getSheets`);
                    const data = await response.json();
                    setSheets(data);
                    if (data.length > 0) setSelectedSheet(data[0]);
                } catch (err) {
                    console.error("Fetch Error", err);
                    setError("無法連結資料庫，請檢查 URL 是否正確。");
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!idCode || idCode.length !== 5) {
                    setError("請輸入正確的身分證後五碼");
                    return;
                }
                
                if (!apiUrl && !isDemo) {
                    setIsDemo(true);
                    mockLogin();
                    return;
                }

                if (isDemo) {
                    mockLogin();
                    return;
                }
                fetchData(selectedSheet);
            };

            const mockLogin = () => {
                setLoading(true);
                setTimeout(() => {
                    setSheets(['第一學期第一次評量', '第一學期第二次評量']);
                    setSelectedSheet('第一學期第一次評量');
                    mockFetchData();
                    setLoading(false);
                }, 1000);
            };

            const mockFetchData = () => {
                setView('dashboard');
                setStudentData({
                    seat: "05",
                    name: "王小明",
                    avg: 88.5,
                    total: 442.5,
                    scores: {
                        "國語": { "定期": 88, "平時": 90 },
                        "英語": { "定期": 92, "平時": 95 },
                        "數學": { "定期": 78, "平時": 85 },
                        "社會": { "定期": 95, "平時": 92 },
                        "自然": { "定期": 85, "平時": 88 }
                    }
                });
                setStatsData({
                    "國語": { avg: 82.3, highScore: 90, dist: { "100": 1, "90-99": 5, "80-89": 10, "70-79": 8, "60-69": 4, "under60": 2 } },
                    "英語": { avg: 75.5, highScore: 88, dist: { "100": 0, "90-99": 3, "80-89": 8, "70-79": 10, "60-69": 6, "under60": 3 } },
                    "數學": { avg: 68.2, highScore: 85, dist: { "100": 0, "90-99": 2, "80-89": 5, "70-79": 8, "60-69": 8, "under60": 7 } },
                    "社會": { avg: 85.1, highScore: 94, dist: { "100": 2, "90-99": 8, "80-89": 12, "70-79": 6, "60-69": 2, "under60": 0 } },
                    "自然": { avg: 79.4, highScore: 89, dist: { "100": 1, "90-99": 4, "80-89": 9, "70-79": 9, "60-69": 5, "under60": 2 } },
                });
            };

            const fetchData = async (sheetName) => {
                setLoading(true);
                setError('');
                try {
                    const url = `${apiUrl}?action=getData&sheetName=${encodeURIComponent(sheetName)}&loginId=${idCode}`;
                    const response = await fetch(url);
                    const json = await response.json();
                    
                    if (json.status === 'error') {
                        setError(json.message);
                    } else {
                        setStudentData(json.data);
                        setStatsData(json.stats);
                        setView('dashboard');
                    }
                } catch (err) {
                    setError("讀取資料失敗，請稍後再試。");
                } finally {
                    setLoading(false);
                }
            };

            const handleSheetChange = (e) => {
                const newSheet = e.target.value;
                setSelectedSheet(newSheet);
                if (isDemo) {
                   // Refresh demo data if needed
                } else {
                    fetchData(newSheet);
                }
            };

            const handleLogout = () => {
                setView('login');
                setIdCode('');
                setStudentData(null);
                setStatsData(null);
                setError('');
            };

            // Helper to render score cell
            const ScoreCell = ({ val }) => (
                <td className="px-3 py-4 text-center text-gray-700 font-medium whitespace-nowrap border-r border-gray-100 last:border-0">
                    {val !== undefined && val !== "" ? val : "-"}
                </td>
            );

            // Helper to render header cell
            const HeaderCell = ({ label, colorClass = "bg-gray-50" }) => (
                <th className={`px-3 py-3 text-center text-xs font-bold text-gray-700 whitespace-nowrap border-r border-gray-200 ${colorClass}`}>
                    {label}
                </th>
            );

            return (
                <div className="min-h-screen flex items-center justify-center py-8 px-4">
                    {view === 'login' ? (
                        <div className="glass-card w-full max-w-md p-8 rounded-2xl shadow-xl animate-fade-in">
                            <div className="text-center mb-8">
                                <i className="ph ph-student text-5xl text-blue-600 mb-3"></i>
                                <h1 className="text-2xl font-bold text-gray-800">成績查詢系統</h1>
                                <p className="text-gray-500 text-sm mt-2">請輸入資料進行驗證</p>
                            </div>

                            <form onSubmit={handleLogin} className="space-y-6">
                                {/* API URL Input for demo */}
                                {(!DEFAULT_API_URL && !isDemo) && (
                                    <div className="bg-yellow-50 p-3 rounded border border-yellow-200 text-xs text-yellow-800 mb-4">
                                        <label className="block font-bold mb-1">系統設定 (首次使用請填寫):</label>
                                        <input 
                                            type="text" 
                                            placeholder="請貼上 Google Apps Script 網址"
                                            className="w-full p-2 border rounded"
                                            value={apiUrl}
                                            onChange={(e) => setApiUrl(e.target.value)}
                                        />
                                        <div className="mt-1 text-gray-400">若未填寫將進入演示模式 (Demo Mode)</div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">身分證字號 (後五碼)</label>
                                    <input 
                                        type="text" 
                                        value={idCode}
                                        onChange={(e) => setIdCode(e.target.value)}
                                        placeholder="例如: 12345"
                                        maxLength="5"
                                        className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                    />
                                </div>

                                {error && (
                                    <div className="flex items-center text-red-600 text-sm bg-red-50 p-3 rounded-lg">
                                        <i className="ph ph-warning-circle mr-2"></i>
                                        {error}
                                    </div>
                                )}

                                <button 
                                    type="submit" 
                                    disabled={loading}
                                    className="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 px-4 rounded-lg transition transform active:scale-95 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center"
                                >
                                    {loading ? (
                                        <i className="ph ph-spinner animate-spin text-xl"></i>
                                    ) : "登入查詢"}
                                </button>
                            </form>
                        </div>
                    ) : (
                        <div className="w-full max-w-[95%] animate-fade-in space-y-6">
                            {/* Header Bar */}
                            <div className="glass-card rounded-xl p-4 flex flex-col md:flex-row justify-between items-center shadow-sm">
                                <div className="flex items-center space-x-4 mb-4 md:mb-0 w-full md:w-auto">
                                    <div className="bg-blue-100 p-2 rounded-full">
                                        <i className="ph ph-exam text-blue-600 text-xl"></i>
                                    </div>
                                    <select 
                                        value={selectedSheet} 
                                        onChange={handleSheetChange}
                                        className="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full md:w-64 p-2.5"
                                    >
                                        {sheets.map(sheet => (
                                            <option key={sheet} value={sheet}>{sheet}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div className="flex items-center space-x-4">
                                    <div className="text-right hidden md:block">
                                        <div className="text-sm font-bold text-gray-800">{studentData?.name}</div>
                                        <div className="text-xs text-gray-500">座號: {studentData?.seat}</div>
                                    </div>
                                    <button 
                                        onClick={handleLogout}
                                        className="text-gray-500 hover:text-red-600 transition p-2"
                                        title="登出"
                                    >
                                        <i className="ph ph-sign-out text-xl"></i>
                                    </button>
                                </div>
                            </div>

                            {/* Main Content */}
                            {loading ? (
                                <div className="text-center py-20">
                                    <i className="ph ph-spinner animate-spin text-4xl text-blue-500"></i>
                                    <p className="mt-4 text-gray-500">資料讀取中...</p>
                                </div>
                            ) : (
                                <>
                                    {/* Spreadsheet Style Table */}
                                    <div className="glass-card rounded-2xl shadow-lg overflow-hidden">
                                        <div className="bg-blue-600 px-6 py-4">
                                            <h2 className="text-white font-bold flex items-center">
                                                <i className="ph ph-table mr-2"></i> 成績列表
                                            </h2>
                                        </div>
                                        <div className="overflow-x-auto scrollbar-hide">
                                            <table className="min-w-full divide-y divide-gray-200">
                                                <thead>
                                                    <tr className="bg-gray-50">
                                                        <HeaderCell label="座號" colorClass="bg-gray-100" />
                                                        <HeaderCell label="姓名" colorClass="bg-gray-100" />
                                                        <HeaderCell label="國語定期" colorClass="bg-blue-50" />
                                                        <HeaderCell label="國語平時" />
                                                        <HeaderCell label="英語定期" colorClass="bg-blue-50" />
                                                        <HeaderCell label="英語平時" />
                                                        <HeaderCell label="數學定期" colorClass="bg-blue-50" />
                                                        <HeaderCell label="數學平時" />
                                                        <HeaderCell label="社會定期" colorClass="bg-blue-50" />
                                                        <HeaderCell label="社會平時" />
                                                        <HeaderCell label="自然定期" colorClass="bg-blue-50" />
                                                        <HeaderCell label="自然平時" />
                                                        <HeaderCell label="平均" colorClass="bg-yellow-50 text-blue-600" />
                                                        <HeaderCell label="總分" colorClass="bg-yellow-50" />
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-200">
                                                    <tr>
                                                        <td className="px-3 py-4 text-center font-bold text-gray-800 bg-gray-50 border-r">{studentData?.seat}</td>
                                                        <td className="px-3 py-4 text-center font-bold text-gray-800 bg-gray-50 border-r sticky left-0">{studentData?.name}</td>
                                                        
                                                        {/* Subjects */}
                                                        <ScoreCell val={studentData?.scores['國語']?.['定期']} />
                                                        <ScoreCell val={studentData?.scores['國語']?.['平時']} />
                                                        <ScoreCell val={studentData?.scores['英語']?.['定期']} />
                                                        <ScoreCell val={studentData?.scores['英語']?.['平時']} />
                                                        <ScoreCell val={studentData?.scores['數學']?.['定期']} />
                                                        <ScoreCell val={studentData?.scores['數學']?.['平時']} />
                                                        <ScoreCell val={studentData?.scores['社會']?.['定期']} />
                                                        <ScoreCell val={studentData?.scores['社會']?.['平時']} />
                                                        <ScoreCell val={studentData?.scores['自然']?.['定期']} />
                                                        <ScoreCell val={studentData?.scores['自然']?.['平時']} />
                                                        
                                                        {/* Totals */}
                                                        <td className="px-3 py-4 text-center font-bold text-blue-600 bg-yellow-50 border-r">{studentData?.avg}</td>
                                                        <td className="px-3 py-4 text-center font-bold text-gray-800 bg-yellow-50">{studentData?.total}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* Distribution Analysis */}
                                    <h3 className="text-xl font-bold text-gray-800 mt-8 mb-4 pl-2 border-l-4 border-blue-500">班級成績組距分析 (定期)</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                                        {['國語', '英語', '數學', '社會', '自然'].map(subject => {
                                            const dist = statsData?.[subject]?.dist;
                                            if (!dist) return null;
                                            
                                            return (
                                                <div key={subject} className="glass-card rounded-xl p-4 shadow-sm border-t-4 border-blue-500">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <h4 className="font-bold text-lg text-gray-800">{subject}</h4>
                                                        <div className="text-xs space-y-1 text-right">
                                                            <div className="text-gray-500">平均: <span className="font-bold text-blue-600">{statsData[subject].avg}</span></div>
                                                            <div className="text-gray-500">高標: <span className="font-bold text-purple-600">{statsData[subject].highScore}</span></div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="space-y-2">
                                                        {[
                                                            { label: '100', key: '100', color: 'bg-green-500' },
                                                            { label: '90-99', key: '90-99', color: 'bg-emerald-400' },
                                                            { label: '80-89', key: '80-89', color: 'bg-blue-400' },
                                                            { label: '70-79', key: '70-79', color: 'bg-indigo-400' },
                                                            { label: '60-69', key: '60-69', color: 'bg-yellow-400' },
                                                            { label: '<60', key: 'under60', color: 'bg-red-400' },
                                                        ].map((range) => {
                                                            const count = dist[range.key];
                                                            const total = statsData[subject].count || 1;
                                                            const percentage = (count / total) * 100;
                                                            
                                                            return (
                                                                <div key={range.key} className="flex items-center text-xs">
                                                                    <div className="w-10 font-medium text-gray-500">{range.label}</div>
                                                                    <div className="flex-1 mx-1.5 bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                                                        <div 
                                                                            className={`h-1.5 rounded-full ${range.color}`} 
                                                                            style={{ width: `${percentage}%` }}
                                                                        ></div>
                                                                    </div>
                                                                    <div className="w-6 text-right font-bold text-gray-700">{count}</div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
